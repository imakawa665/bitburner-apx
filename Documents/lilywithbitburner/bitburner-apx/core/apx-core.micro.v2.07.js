/** apx-core.micro.v2.07.js (compact reprint) */
export async function main(ns){ns.disableLog('sleep');ns.clearPort(20);ns.clearPort(21);let F=ns.flags([['cmdPort',20],['statPort',21],['mode','auto'],['target',''],['secPad',0.5],['moneyThr',0.95],['wgSleep',1200]]);let Z=['n00dles','foodnstuff','sigma-cosmetics','joesguns','nectar-net','hong-fang-tea','harakiri-sushi'];let S={paused:false,mode:F.mode,target:F.target||'',last:0};let me=()=>ns.getPlayer().skills.hacking;let ok=h=>{if(ns.hasRootAccess(h))return true;if(!ns.fileExists('NUKE.exe','home'))return false;try{ns.nuke(h);}catch{}return ns.hasRootAccess(h)};let pick=()=>{if(S.target&&ns.serverExists(S.target))return S.target;let b='',sc=-1;for(let h of Z){if(ns.getServerNumPortsRequired(h)!==0||ns.getServerRequiredHackingLevel(h)>me())continue;if(!ok(h))continue;let m=ns.getServerMaxMoney(h)||0;let s=m/(1+ns.getServerRequiredHackingLevel(h)||1);if(s>sc){sc=s;b=h}}S.target=b;return b};let snap=h=>({money:ns.getServerMoneyAvailable(h),max:ns.getServerMaxMoney(h),sec:ns.getServerSecurityLevel(h),min:ns.getServerMinSecurityLevel(h)});while(true){let t=pick();if(!t){await ns.sleep(500);continue}if(!S.paused){let s=snap(t);let m=S.mode;if(m==='auto'){if(s.sec>s.min+F.secPad)m='weaken';else if(s.max>0&&s.money<s.max*F.moneyThr)m='grow';else m='hack'}if(m==='weaken')await ns.run('apx-w1.js',1,t);else if(m==='grow')await ns.run('apx-g1.js',1,t);else await ns.run('apx-h1.js',1,t)}await ns.sleep(F.wgSleep)}}
