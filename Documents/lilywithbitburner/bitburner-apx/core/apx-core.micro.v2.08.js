/** apx-core.micro.v2.08.js (compact reprint) */
export async function main(ns){ns.disableLog('sleep');ns.clearPort(20);ns.clearPort(21);let F=ns.flags([['cmdPort',20],['statPort',21],['mode','auto'],['target',''],['secPad',0.5],['moneyThr',0.95],['wgSleep',1200],['allRooted',false]]);let S={paused:false,mode:F.mode,target:F.target||'',last:0,scan:0,disc:['n00dles','foodnstuff']};let disc=()=>{if(!F.allRooted&&S.disc.length>0)return S.disc;if(Date.now()-S.scan<2000)return S.disc;let seen=new Set(['home']);let q=['home'];while(q.length){let c=q.pop();for(let n of ns.scan(c)){if(!seen.has(n)){seen.add(n);q.push(n)}}}S.disc=[...seen].filter(h=>h!=='home');S.scan=Date.now();return S.disc};let cands=()=>{let me=ns.getPlayer().skills.hacking;if(!F.allRooted)return['n00dles','foodnstuff','sigma-cosmetics','joesguns','nectar-net','hong-fang-tea','harakiri-sushi'].filter(h=>ns.serverExists(h)&&ns.getServerNumPortsRequired(h)===0&&ns.getServerRequiredHackingLevel(h)<=me);let skip=new Set(['home','darkweb',...(ns.getPurchasedServers?.()??[])]);let list=[];for(let h of disc()){if(skip.has(h))continue;if(!ns.serverExists(h))continue;if(!ns.hasRootAccess(h))continue;if(ns.getServerRequiredHackingLevel(h)>me)continue;if((ns.getServerMaxMoney(h)||0)<=0)continue;list.push(h)}return list};let pick=()=>{if(S.target&&ns.serverExists(S.target))return S.target;let b='',sc=-1;for(let h of cands()){let m=ns.getServerMaxMoney(h)||0,req=ns.getServerRequiredHackingLevel(h)||1;let s=m/(1+req);if(s>sc){sc=s;b=h}}S.target=b;return b};let snap=h=>({money:ns.getServerMoneyAvailable(h),max:ns.getServerMaxMoney(h),sec:ns.getServerSecurityLevel(h),min:ns.getServerMinSecurityLevel(h)});let run=async(f,a=[],p=1e9)=>{let max=ns.getServerMaxRam('home'),used=ns.getServerUsedRam('home'),free=Math.max(0,max-used);if(free<1)return 0;let th=Math.min(p,Math.max(1,Math.floor(free/2))),st=0;while(th>0){let pid=ns.run(f,th,...a);if(pid!==0){st=th;break}th=Math.floor(th/2);await ns.sleep(50)}return st};while(true){let t=pick();if(!t){await ns.sleep(500);continue}let s=snap(t);let m=F.mode;if(m==='auto'){if(s.sec>s.min+F.secPad)m='weaken';else if(s.max>0&&s.money<s.max*F.moneyThr)m='grow';else m='hack'}if(m==='weaken')await run('apx-w1.js',[t]);else if(m==='grow')await run('apx-g1.js',[t]);else await run('apx-h1.js',[t],16);await ns.sleep(F.wgSleep)}}
