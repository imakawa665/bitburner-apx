/** apx-core.nano.v2.06.js (compact reprint) */
export async function main(ns){ns.disableLog('sleep');ns.clearPort(20);ns.clearPort(21);let F=ns.flags([['cmdPort',20],['statPort',21],['mode','auto'],['target',''],['secPad',0.5],['moneyThr',0.9],['wgSleep',800]]);let S={paused:false,mode:F.mode,target:F.target||'',last:0};let Z=['n00dles','foodnstuff','sigma-cosmetics','joesguns','nectar-net','hong-fang-tea','harakiri-sushi'];let me=()=>ns.getPlayer().skills.hacking;let ok=h=>{if(ns.hasRootAccess(h))return true;if(!ns.fileExists('NUKE.exe','home'))return false;try{ns.nuke(h);}catch{}return ns.hasRootAccess(h)};let pick=()=>{if(S.target&&ns.serverExists(S.target))return S.target;let b='',sc=-1;for(let h of Z){if(ns.getServerNumPortsRequired(h)!==0||ns.getServerRequiredHackingLevel(h)>me())continue;if(!ok(h))continue;let m=ns.getServerMaxMoney(h)||0;let s=m/(1+ns.getServerRequiredHackingLevel(h)||1);if(s>sc){sc=s;b=h}}S.target=b;return b};let snap=h=>({money:ns.getServerMoneyAvailable(h),max:ns.getServerMaxMoney(h),sec:ns.getServerSecurityLevel(h),min:ns.getServerMinSecurityLevel(h)});let run=async(f,a=[],p=1e9)=>{let max=ns.getServerMaxRam('home'),used=ns.getServerUsedRam('home'),free=Math.max(0,max-used);if(free<1)return 0;let th=Math.min(p,Math.max(1,Math.floor(free/2))),st=0;while(th>0){let pid=ns.run(f,th,...a);if(pid!==0){st=th;break}th=Math.floor(th/2);await ns.sleep(50)}return st};while(true){let t=pick();if(!t){await ns.sleep(500);continue}if(!S.paused){let s=snap(t);let m=F.mode;if(m==='auto'){if(s.sec>s.min+F.secPad)m='weaken';else if(s.max>0&&s.money<s.max*F.moneyThr)m='grow';else m='hack'}if(m==='weaken')await run('apx-w1.js',[t]);else if(m==='grow')await run('apx-g1.js',[t]);else await run('apx-h1.js',[t],32)}if(Date.now()-S.last>1000){S.last=Date.now()}await ns.sleep(F.wgSleep)}}
